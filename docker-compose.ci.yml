# docker-compose.ci.yml - Run CI environment locally exactly like GitHub Actions
---
version: '3.8'

services:
  # Run all CI lint checks (default)
  ci-lint:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    container_name: ci-lint-runner
    volumes:
      # Mount source code for real-time changes (read-only)
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
      - ./context:/app/context
      # Mount config files
      - ./mypy.ini:/app/mypy.ini:ro
      - ./.flake8:/app/.flake8:ro
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./.pre-commit-config.yaml:/app/.pre-commit-config.yaml:ro
      - ./.yamllint-workflows.yml:/app/.yamllint-workflows.yml:ro
    environment:
      - PYTHONPATH=/app
      - CI=true
      - PYTHONUNBUFFERED=1
    command: /bin/bash scripts/test-like-ci.sh

  # Run specific checks individually
  ci-black:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
    environment:
      - CI=true
    command: black --check src/ tests/ scripts/

  ci-isort:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
    environment:
      - CI=true
    command: isort --check-only --profile black src/ tests/ scripts/

  ci-flake8:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
      - ./.flake8:/app/.flake8:ro
    environment:
      - CI=true
    command: >
      flake8 src/ tests/ scripts/ --max-line-length=100
      --extend-ignore=E203,W503

  ci-mypy:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./mypy.ini:/app/mypy.ini:ro
    environment:
      - CI=true
    command: mypy src/ --config-file=mypy.ini

  ci-context-lint:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./context:/app/context
    environment:
      - CI=true
      - PYTHONPATH=/app
    command: python -m src.agents.context_lint validate context/

  ci-import-check:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    environment:
      - CI=true
      - PYTHONPATH=/app
    command: python -m pytest --collect-only -q

  # Service for interactive debugging
  ci-debug:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src
      - ./tests:/app/tests
      - ./scripts:/app/scripts
      - ./context:/app/context
      - ./.pre-commit-config.yaml:/app/.pre-commit-config.yaml
      - ./pyproject.toml:/app/pyproject.toml
      - ./mypy.ini:/app/mypy.ini
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    command: /bin/bash
    stdin_open: true
    tty: true

  # Test GitHub Actions workflows (simple version)
  ci-workflow-simple:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
      - ./context:/app/context
      - ./.github:/app/.github:ro
      - ./infra:/app/infra:ro
    environment:
      - PYTHONPATH=/app
      - CI=true
    command: /bin/bash scripts/test-workflow-simple.sh

  # Test coverage like GitHub Actions
  ci-coverage:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
      - ./context:/app/context
      - ./.coverage-config.json:/app/.coverage-config.json:ro
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./pytest.ini:/app/pytest.ini:ro
    environment:
      - PYTHONPATH=/app
      - CI=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    command: /bin/bash scripts/test-coverage-like-ci.sh

  # Test unit tests like GitHub Actions
  ci-unit-tests:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
      - ./context:/app/context
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./pytest.ini:/app/pytest.ini:ro
    environment:
      - PYTHONPATH=/app
      - CI=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    command: /bin/bash scripts/test-unit-like-ci.sh

  # Test suite like GitHub Actions
  ci-test-suite:
    build:
      context: .
      dockerfile: Dockerfile.ci
    image: agent-context-ci:latest
    volumes:
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
      - ./scripts:/app/scripts:ro
      - ./context:/app/context
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./pytest.ini:/app/pytest.ini:ro
    environment:
      - PYTHONPATH=/app
      - CI=true
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    command: /bin/bash scripts/test-suite-like-ci.sh

  # Qdrant service for workflow tests
  qdrant:
    image: qdrant/qdrant:v1.14.1
    ports:
      - "6335:6333"
      - "6336:6334"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/collections"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j service for workflow tests
  neo4j:
    image: neo4j:5.20.0
    ports:
      - "7688:7687"
      - "7475:7474"
    environment:
      - NEO4J_AUTH=neo4j/testpassword
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      # Memory optimization for CI
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", 
        "testpassword", "RETURN 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis service for tests that need it
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
