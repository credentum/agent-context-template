---
name: Verify Local CI Results

on:
  # Triggered when local CI posts results
  repository_dispatch:
    types: [ci-results-posted]

  # Also check on PR events to ensure results exist
  pull_request:
    types: [opened, synchronize, reopened]

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to verify'
        required: false
        type: string

permissions:
  contents: read
  checks: write
  pull-requests: write
  statuses: write

jobs:
  verify-results:
    name: Verify Local CI Results
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyGithub requests python-gnupg

      - name: Extract PR information
        id: pr-info
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "pr_number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
            echo "head_sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
          else
            # Workflow dispatch
            echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            # Get SHA from PR if provided
            if [[ -n "${{ inputs.pr_number }}" ]]; then
              SHA=$(gh pr view ${{ inputs.pr_number }} --json headRefOid -q .headRefOid)
              echo "head_sha=${SHA}" >> $GITHUB_OUTPUT
            else
              echo "head_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Fetch CI Results
        id: fetch-results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # For Phase 1, we'll look for results in:
          # 1. Check runs created by post-ci-results.py
          # 2. PR comments with CI results
          # 3. Artifacts (future phase)

          SHA="${{ steps.pr-info.outputs.head_sha }}"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"

          echo "Looking for CI results for SHA: ${SHA:0:8}"

          # Try to find check runs first
          CHECK_RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/commits/${SHA}/check-runs" \
            --jq '.check_runs[] | select(.name == "Local CI Results") | {id: .id, conclusion: .conclusion, output: .output}')

          if [[ -n "$CHECK_RUNS" ]]; then
            echo "Found check run with local CI results"
            echo "$CHECK_RUNS" > ci-results.json
            echo "source=check_run" >> $GITHUB_OUTPUT
          elif [[ -n "$PR_NUMBER" ]]; then
            # Try to find PR comment with results
            echo "Looking for CI results in PR #$PR_NUMBER comments"

            # Get comments and look for our CI results comment
            COMMENT=$(gh pr view $PR_NUMBER --json comments \
              --jq '.comments[] | select(.body | contains("ðŸ¤– Local CI Results")) | .body' | head -1)

            if [[ -n "$COMMENT" ]]; then
              echo "Found CI results in PR comment"
              # Extract JSON from comment (between ```json and ```)
              echo "$COMMENT" | sed -n '/```json/,/```/{//!p}' > ci-results.json
              echo "source=pr_comment" >> $GITHUB_OUTPUT
            else
              echo "No CI results found"
              echo "source=none" >> $GITHUB_OUTPUT
            fi
          else
            echo "No CI results found"
            echo "source=none" >> $GITHUB_OUTPUT
          fi

      - name: Extract CI Results and Signature
        id: extract-results
        if: steps.fetch-results.outputs.source != 'none'
        run: |
          # For check runs, extract the external_id which contains signature
          if [[ "${{ steps.fetch-results.outputs.source }}" == "check_run" ]]; then
            # Get the full check run data including external_id
            SHA="${{ steps.pr-info.outputs.head_sha }}"
            CHECK_RUN=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/commits/${SHA}/check-runs" \
              --jq '.check_runs[] | select(.name == "Local CI Results") | {external_id: .external_id, output: .output}' | head -1)

            if [[ -n "$CHECK_RUN" ]]; then
              # Extract signature from external_id if present
              EXTERNAL_ID=$(echo "$CHECK_RUN" | jq -r '.external_id // empty')
              if [[ -n "$EXTERNAL_ID" ]]; then
                # Parse the external_id JSON to get signature
                echo "$EXTERNAL_ID" | jq -r '.signature // empty' > signature.txt
                echo "has_signature=true" >> $GITHUB_OUTPUT
              else
                echo "has_signature=false" >> $GITHUB_OUTPUT
              fi

              # Extract the actual results from output summary
              # This is a simplified extraction - in production, we'd parse more carefully
              echo "$CHECK_RUN" | jq -r '.output.summary' > raw-summary.txt
            fi
          fi

      - name: Verify CI Results
        id: verify
        if: steps.fetch-results.outputs.source != 'none'
        run: |
          # Use the actual verify-ci-results.py script
          # First check if public key exists
          if [[ -f ".github/ci-public-key.asc" ]]; then
            echo "Public key found for signature verification"
            PUBLIC_KEY_ARG="--public-key .github/ci-public-key.asc"
          else
            echo "No public key found, signature verification will be skipped"
            PUBLIC_KEY_ARG=""
          fi

          # Run verification
          if python scripts/verify-ci-results.py ci-results.json $PUBLIC_KEY_ARG --output-format json > verify-output.json; then
            PASSED="true"
          else
            PASSED="false"
          fi

          # Extract message from JSON output
          MESSAGE=$(jq -r '.message' verify-output.json)

          # Set outputs
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "${MESSAGE}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Exit with appropriate code
          if [[ "${PASSED}" != "true" ]]; then
            exit 1
          fi

      - name: Update PR Status
        if: always() && steps.pr-info.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          SHA="${{ steps.pr-info.outputs.head_sha }}"

          if [[ "${{ steps.fetch-results.outputs.source }}" == "none" ]]; then
            # No results found
            STATE="pending"
            DESCRIPTION="Waiting for local CI results to be posted"
            CONTEXT="Local CI Verification"
          elif [[ "${{ steps.verify.outputs.passed }}" == "true" ]]; then
            STATE="success"
            DESCRIPTION="Local CI results verified - all checks passed"
            CONTEXT="Local CI Verification"
          else
            STATE="failure"
            DESCRIPTION="Local CI verification failed"
            CONTEXT="Local CI Verification"
          fi

          # Post status to commit
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/statuses/${SHA}" \
            -f state="${STATE}" \
            -f description="${DESCRIPTION}" \
            -f context="${CONTEXT}" \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Post Summary
        if: always()
        run: |
          if [[ "${{ steps.fetch-results.outputs.source }}" == "none" ]]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## â³ Local CI Results Not Found

          This workflow verifies locally-executed CI results, but no results were found for this PR.

          ### How to post CI results:

          1. Run CI locally:
             ```bash
             ./scripts/claude-ci.sh all --output ci-output.json
             ```

          2. Post results to GitHub:
             ```bash
             ./scripts/post-ci-results.py ci-output.json --pr ${{ steps.pr-info.outputs.pr_number }}
             ```

          3. (Optional) Enable signing for enhanced security:
             ```bash
             ./scripts/post-ci-results.py ci-output.json --pr ${{ steps.pr-info.outputs.pr_number }} --enable-signing
             ```

          The workflow will automatically re-run when results are posted.
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“Š Local CI Verification Results

          **Source**: ${{ steps.fetch-results.outputs.source }}
          **Status**: ${{ steps.verify.outputs.passed == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
          **Signature**: ${{ steps.extract-results.outputs.has_signature == 'true' && 'ðŸ” Verified' || 'âš ï¸ Not signed' }}

          ### Details:
          ${{ steps.verify.outputs.message }}

          ---

          This workflow verified CI results that were executed locally and posted to GitHub.
          EOF
          fi
