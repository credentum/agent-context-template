---
###############################################################################
# 🚨 PR Conflict Validator - Prevent Conflicting PRs from Being Merged
# Runs comprehensive conflict detection before any merge attempt
###############################################################################
name: PR Conflict Validator

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Removed pull_request_target to prevent duplicate jobs

jobs:
  validate-conflicts:
    name: "🔍 Conflict Detection"
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout PR head (contains reusable actions)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Fetch base and PR branches for conflict detection
        run: |
          git fetch origin ${{ github.event.pull_request.head.ref }}:pr-branch
          git fetch origin ${{ github.event.pull_request.base.ref }}:base-branch

      - name: Comprehensive conflict detection
        id: conflict-check
        run: |
          echo "🔍 Running comprehensive conflict detection..."

          PR_HEAD="${{ github.event.pull_request.head.sha }}"
          BASE_HEAD="${{ github.event.pull_request.base.sha }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"

          echo "PR HEAD: $PR_HEAD"
          echo "BASE HEAD: $BASE_HEAD"
          echo "PR NUMBER: $PR_NUMBER"
          echo "HEAD REF: $HEAD_REF"
          echo "BASE REF: $BASE_REF"

          # Get current merge status from GitHub API
          MERGEABLE_STATE=$(gh pr view $PR_NUMBER --json mergeable,mergeStateStatus --jq '{mergeable: .mergeable, state: .mergeStateStatus}')
          echo "GitHub merge status: $MERGEABLE_STATE"

          MERGEABLE=$(echo "$MERGEABLE_STATE" | jq -r '.mergeable')
          MERGE_STATE=$(echo "$MERGEABLE_STATE" | jq -r '.state')

          echo "mergeable=$MERGEABLE" >> $GITHUB_OUTPUT
          echo "merge_state_status=$MERGE_STATE" >> $GITHUB_OUTPUT

          # Test 1: GitHub's built-in mergeable check
          if [ "$MERGEABLE" = "CONFLICTING" ]; then
            echo "❌ GitHub reports PR has conflicts"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "conflict_type=github_api" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Test 2: Check merge state status
          if [ "$MERGE_STATE" = "DIRTY" ] || [ "$MERGE_STATE" = "BLOCKED" ]; then
            echo "❌ Merge state is $MERGE_STATE"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "conflict_type=merge_state" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Test 3: Manual merge simulation
          echo "🧪 Simulating merge to detect conflicts..."

          git checkout base-branch
          git checkout -b merge-test

          if git merge pr-branch --no-commit --no-ff; then
            echo "✅ Merge simulation successful - no conflicts detected"
            git merge --abort 2>/dev/null || true
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            echo "conflict_type=none" >> $GITHUB_OUTPUT
          else
            echo "❌ Merge simulation failed - conflicts detected"
            git merge --abort 2>/dev/null || true
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "conflict_type=merge_simulation" >> $GITHUB_OUTPUT
          fi

          # Test 4: Check for divergent history using centralized git commands
          echo "🔍 Checking divergent history using reliable git commands"

          # Store SHA values for the centralized git action
          echo "pr_head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          echo "pr_base_sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT

      - name: Check Commits Behind
        id: commits-behind
        uses: ./.github/actions/git-pr-commands
        with:
          command: commits-behind
          head-sha: ${{ github.event.pull_request.head.sha }}
          base-sha: ${{ github.event.pull_request.base.sha }}

      - name: Check Commits Ahead
        id: commits-ahead
        uses: ./.github/actions/git-pr-commands
        with:
          command: commits-ahead
          head-sha: ${{ github.event.pull_request.head.sha }}
          base-sha: ${{ github.event.pull_request.base.sha }}

      - name: Process Divergent History Results
        id: process-results
        run: |
          COMMITS_BEHIND="${{ steps.commits-behind.outputs.result }}"
          COMMITS_AHEAD="${{ steps.commits-ahead.outputs.result }}"

          echo "Commits behind base: $COMMITS_BEHIND"
          echo "Commits ahead of base: $COMMITS_AHEAD"

          echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          echo "commits_ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT

          # If branch is significantly behind, flag for update
          if [ "$COMMITS_BEHIND" -gt 10 ]; then
            echo "⚠️ Branch is significantly behind base ($COMMITS_BEHIND commits)"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Set workflow status
        run: |
          has_conflicts="${{ steps.conflict-check.outputs.has_conflicts }}"
          conflict_type="${{ steps.conflict-check.outputs.conflict_type }}"

          if [ "$has_conflicts" = "true" ]; then
            echo "❌ Conflicts detected via $conflict_type. Manual resolution required."
            exit 1
          else
            echo "✅ No conflicts detected. PR can be safely merged."
            exit 0
          fi

      - name: Comment on PR if conflicts detected
        if: steps.conflict-check.outputs.has_conflicts == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const conflictType = '${{ steps.conflict-check.outputs.conflict_type }}';
            const commitsBehind = '${{ steps.process-results.outputs.commits_behind }}';

            // Only show branch status for merge simulation conflicts
            const branchStatusText = conflictType === 'merge_simulation' && commitsBehind > 0
              ? `\n**Branch Status**: ${commitsBehind} commits behind base branch`
              : '';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ❌ Conflicts Detected

            **Detection Method**: ${conflictType}${branchStatusText}

            ### 🔧 Resolution Steps:

            1. **Update your branch**:
               \`\`\`bash
               git checkout ${{ github.event.pull_request.head.ref }}
               git fetch origin
               git merge origin/${{ github.event.pull_request.base.ref }}
               # Resolve any conflicts
               git push origin ${{ github.event.pull_request.head.ref }}
               \`\`\`

            2. **Or rebase your branch**:
               \`\`\`bash
               git checkout ${{ github.event.pull_request.head.ref }}
               git fetch origin
               git rebase origin/${{ github.event.pull_request.base.ref }}
               # Resolve any conflicts
               git push origin ${{ github.event.pull_request.head.ref }} --force-with-lease
               \`\`\`

            ### 🚨 Auto-merge Blocked
            This PR will not be auto-merged until conflicts are resolved.

            _This is an automated message from the PR Conflict Validator._`
            });
